<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPA 028ãƒ‡ã‚£ãƒ“ã‚¸ãƒ§ãƒ³ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 8px; background-color: #f4f4f9; }
        .container { max-width: 100%; margin: auto; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #004d99; border-bottom: 3px solid #004d99; padding-bottom: 8px; text-align: center; font-size: 1.4em; margin: 10px 0; }
        h2 { font-size: 1.1em; margin: 15px 0 10px 0; color: #004d99; border-bottom: 2px solid #004d99; padding-bottom: 5px; }
        .update-info { text-align: right; font-size: 0.75em; color: #666; margin-bottom: 10px; }
        
        @media (min-width: 1024px) {
            .container { max-width: 50vw; }
        }
        
        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãƒªã‚¹ãƒˆï¼‰ */
        .ranking-list { list-style: none; padding: 0; margin: 0; }
        .ranking-list li { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; border-bottom: 1px solid #ddd; font-size: 0.95em;
        }
        .ranking-list li:hover { background-color: #f9f9f9; }
        .ranking-rank { font-weight: bold; font-size: 1.2em; width: 30px; text-align: center; }
        .ranking-rank.gold { color: #ffd700; }
        .ranking-rank.silver { color: #c0c0c0; }
        .ranking-rank.bronze { color: #cd7f32; }
        .ranking-team { flex: 1; margin: 0 10px; }
        .ranking-points { font-weight: bold; color: #cc0000; font-size: 1.05em; }
        
        /* å€‹äººæˆç¸¾ã‚«ãƒ¼ãƒ‰å½¢å¼ */
        #individual-controls { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
            margin-bottom: 10px;
            flex-wrap: nowrap;
        }
        input, select, button { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 0.9em; }
        #search-name { 
            flex: 1; 
            min-width: 0;
        }
        #filter-team, #filter-sl { 
            flex: 0 1 auto; 
            min-width: 80px;
        }
        #clear-filters { 
            flex: 0 0 auto;
            background: #eee; 
            cursor: pointer; 
            padding: 8px 12px;
        }
        button:hover { background: #ddd; }
        
        .individuals-container { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .individual-card { 
            border: 1px solid #ddd; border-radius: 8px; overflow: hidden;
            background: #fafafa; display: flex; flex-direction: column; font-size: 0.9em;
            position: relative; /* for absolute rank */
        }
        .individual-card:hover { background-color: #f8fbff; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
        
        .card-header {
            background-color: #004d99; color: white; padding: 8px 10px; font-weight: bold; font-size: 0.95em;
        }
        
        .card-content {
            padding: 6px 10px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
            padding-right: 56px; /* leave space for rank */
            min-height: 34px; /* reduce height */
        }
        
        .card-name span { font-weight: bold; font-size: 0.98em; }
        
        .card-field { display: flex; flex-direction: column; min-width: 80px; }
        .card-field label { font-weight: bold; color: #004d99; font-size: 0.82em; }
        .card-field span { color: #333; margin-top: 2px; }
        
        .card-rank { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-weight: bold; font-size: 1.2em; color: #004d99; width: 40px; text-align: center; }
        
        @media (max-width: 480px) {
            #search-name { min-width: 0; }
            #filter-team, #filter-sl { min-width: 70px; font-size: 0.85em; }
            #clear-filters { padding: 8px 10px; font-size: 0.8em; }
        }
        
        /* ã‚«ãƒ¼ãƒ‰ã¯å¸¸ã«1åˆ— */
        @media (min-width: 600px) {
            .individuals-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ± JPA 028ãƒ‡ã‚£ãƒ“ã‚¸ãƒ§ãƒ³ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>
        <div class="update-info">
            <span id="checked-date">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</span>
            <span id="source-link"></span>
        </div>
        
        <ul class="ranking-list" id="ranking-body">
            <li style="text-align: center; padding: 15px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</li>
        </ul>
        
        <h2>å€‹äººæˆç¸¾</h2>

        <div id="individual-controls">
            <input id="search-name" type="search" placeholder="åå‰ã§æ¤œç´¢">
            <select id="filter-team">
                <option value="">å…¨ãƒãƒ¼ãƒ </option>
            </select>
            <select id="filter-sl">
                <option value="">å…¨SL</option>
            </select>
            <button id="clear-filters">ã‚¯ãƒªã‚¢</button>
        </div>

        <div id="individuals-container" class="individuals-container">
            <div style="text-align: center; padding: 20px;">å€‹äººæˆç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rankingBody = document.getElementById('ranking-body');
            const updateDateSpan = document.getElementById('update-date');
            const sourceLinkSpan = document.getElementById('source-link');
            
            // Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
            fetch('ranking_data.json?v=' + new Date().getTime()) // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ranking_data.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                    return response.json();
                })
                .then(data => {
                    rankingBody.innerHTML = ''; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
                    
                    // 1. ãƒã‚§ãƒƒã‚¯æ—¥æ™‚ã‚’è¡¨ç¤º
                    const checked = data.last_checked || null;
                    if (checked) {
                        document.getElementById('checked-date').textContent = `æœ€çµ‚ãƒã‚§ãƒƒã‚¯æ—¥æ™‚: ${checked} `;
                    } else {
                        document.getElementById('checked-date').textContent = 'æœ€çµ‚ãƒã‚§ãƒƒã‚¯æ—¥æ™‚: ä¸æ˜';
                    }
                    document.getElementById('source-link').innerHTML = data.source_pdf ? `(<a href="${data.source_pdf}" target="_blank">PDFã‚½ãƒ¼ã‚¹</a>)` : '';

                    // 2. ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ã‚’ç”Ÿæˆï¼ˆãƒªã‚¹ãƒˆå½¢å¼ï¼‰
                    rankingBody.innerHTML = '';
                    data.ranking.forEach((team, index) => {
                        const rank = index + 1;
                        let rankClass = '';
                        if (rank === 1) rankClass = 'gold';
                        else if (rank === 2) rankClass = 'silver';
                        else if (rank === 3) rankClass = 'bronze';

                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span class="ranking-rank ${rankClass}">${rank}</span>
                            <span class="ranking-team">${team.team_name} (No.${team.team_id})</span>
                            <span class="ranking-points">${team.points}pt</span>
                        `;
                        rankingBody.appendChild(li);
                    });

                    // 3. å€‹äººæˆç¸¾ã‚«ãƒ¼ãƒ‰ ã‚’ç”Ÿæˆï¼ˆæ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿å¯¾å¿œï¼‰
                    const indContainer = document.getElementById('individuals-container');
                    indContainer.innerHTML = '';
                    const originalIndividuals = Array.isArray(data.individuals) ? data.individuals.slice() : [];

                    // å…¨ä½“é †ä½ãƒãƒƒãƒ—ã‚’ä½œæˆï¼ˆavg_points é™é †ï¼‰ã€‚ãƒ•ã‚£ãƒ«ã‚¿å¾Œã‚‚ã“ã®é †ä½ã‚’è¡¨ç¤ºã™ã‚‹ã€‚
                    const sortedForRank = originalIndividuals.slice().sort((a, b) => parseFloat(b.avg_points) - parseFloat(a.avg_points));
                    const ranksMap = {};
                    // åŒç‚¹ã¯åŒé †ä½ã«ã™ã‚‹ï¼ˆæ¨™æº–ç«¶æŠ€é †ä½: 1,2,2,4 ã®ã‚ˆã†ã«ã‚¹ã‚­ãƒƒãƒ—ã‚ã‚Šï¼‰
                    let lastAvg = null;
                    let lastRank = 0;
                    sortedForRank.forEach((p, i) => {
                        const key = `${p.team_name}||${p.player_name}`;
                        const avg = parseFloat(p.avg_points) || 0;
                        let rank;
                        if (i === 0) {
                            rank = 1;
                            lastAvg = avg;
                            lastRank = 1;
                        } else {
                            if (Math.abs(avg - lastAvg) < 1e-9) {
                                rank = lastRank;
                            } else {
                                rank = i + 1;
                                lastAvg = avg;
                                lastRank = rank;
                            }
                        }
                        ranksMap[key] = rank;
                    });

                    // ãƒ“ãƒ«ãƒ‰: ãƒãƒ¼ãƒ ã¨SLã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                    const teamSelect = document.getElementById('filter-team');
                    const slSelect = document.getElementById('filter-sl');
                    const teams = new Set();
                    const sls = new Set();
                    originalIndividuals.forEach(p => { teams.add(p.team_name); sls.add(p.sl); });
                    const sortedTeams = Array.from(teams).sort((a,b)=>a.localeCompare(b,'ja'));
                    sortedTeams.forEach(t => {
                        const o = document.createElement('option'); o.value = t; o.textContent = t; teamSelect.appendChild(o);
                    });
                    const sortedSls = Array.from(sls).sort((a,b)=>a-b);
                    sortedSls.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; slSelect.appendChild(o); });

                    // render functionï¼ˆã‚«ãƒ¼ãƒ‰å½¢å¼ï¼‰
                    function renderIndividuals(list) {
                        indContainer.innerHTML = '';
                        if (!list || list.length === 0) {
                            indContainer.innerHTML = '<div style="text-align:center; padding:20px;">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
                            return;
                        }
                        list.forEach((person) => {
                            const avg = (typeof person.avg_points === 'number') ? person.avg_points.toFixed(2) : parseFloat(person.avg_points || 0).toFixed(2);
                            const key = `${person.team_name}||${person.player_name}`;
                            const rank = ranksMap[key] || '';
                            const card = document.createElement('div');
                            card.className = 'individual-card';
                            card.innerHTML = `
                                <div class="card-header">${person.team_name}</div>
                                <div class="card-content">
                                    <div class="card-name">
                                        <span>${person.player_name}</span>
                                    </div>
                                    <div class="card-field">
                                        <label>SL</label>
                                        <span>${person.sl}</span>
                                    </div>
                                    <div class="card-field">
                                        <label>å‹åˆ©</label>
                                        <span>${person.wins}</span>
                                    </div>
                                    <div class="card-field">
                                        <label>å¹³å‡ãƒã‚¤ãƒ³ãƒˆ</label>
                                        <span>${avg}</span>
                                    </div>
                                    <div class="card-field">
                                        <label>ãƒã‚¤ãƒ³ãƒˆç‡</label>
                                        <span>${person.points_rate}</span>
                                    </div>
                                </div>
                                <div class="card-rank">${rank}</div>
                            `;
                            indContainer.appendChild(card);
                        });
                    }

                    // filtering
                    const searchInput = document.getElementById('search-name');
                    const clearBtn = document.getElementById('clear-filters');
                    function applyFilters() {
                        const q = searchInput.value.trim().toLowerCase();
                        const teamVal = teamSelect.value;
                        const slVal = slSelect.value;
                        let filtered = originalIndividuals.filter(p => true);
                        if (q) filtered = filtered.filter(p => (p.player_name || '').toLowerCase().includes(q));
                        if (teamVal) filtered = filtered.filter(p => p.team_name === teamVal);
                        if (slVal) filtered = filtered.filter(p => String(p.sl) === String(slVal));
                        // sort by average points (é™é †)
                        filtered.sort((a, b) => parseFloat(b.avg_points) - parseFloat(a.avg_points));
                        renderIndividuals(filtered);
                    }

                    searchInput.addEventListener('input', applyFilters);
                    teamSelect.addEventListener('change', applyFilters);
                    slSelect.addEventListener('change', applyFilters);
                    clearBtn.addEventListener('click', ()=>{ searchInput.value=''; teamSelect.value=''; slSelect.value=''; applyFilters(); });

                    // initial render: å¹³å‡ç²å¾—ãƒã‚¤ãƒ³ãƒˆé †ï¼ˆé™é †ï¼‰ã§è¡¨ç¤º
                    renderIndividuals(originalIndividuals.sort((a, b) => b.avg_points - a.avg_points));
                })
                .catch(error => {
                    console.error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    rankingBody.innerHTML = '<tr><td colspan="3" style="color: red; text-align: center;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</td></tr>';
                    updateDateSpan.textContent = 'æœ€çµ‚æ›´æ–°æ—¥æ™‚: ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼';
                });
        });
    </script>
</body>
</html>
