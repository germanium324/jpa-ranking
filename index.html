<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPA 028ãƒ‡ã‚£ãƒ“ã‚¸ãƒ§ãƒ³ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 10px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: auto; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #004d99; border-bottom: 3px solid #004d99; padding-bottom: 10px; text-align: center; font-size: 1.5em; }
        h2 { font-size: 1.2em; margin-top: 25px; margin-bottom: 15px; }
        .update-info { text-align: right; font-size: 0.85em; color: #555; margin-bottom: 15px; }
        .table-wrapper { width: 100%; overflow-x: auto; margin-top: 15px; }
        table { width: 100%; min-width: 400px; border-collapse: collapse; }
        th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #ddd; font-size: 0.9em; white-space: nowrap; }
        th { background-color: #004d99; color: white; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f0f0f0; }
        .rank { text-align: center; font-weight: bold; }
        .points { text-align: right; font-weight: bold; color: #cc0000; }
        .gold { background-color: #ffd700; }
        .silver { background-color: #c0c0c0; }
        .bronze { background-color: #cd7f32; }
        #individual-controls { flex-wrap: wrap !important; }
        input, select { font-size: 0.95em; }
        @media (max-width: 600px) {
            .container { padding: 10px; }
            h1 { font-size: 1.3em; padding-bottom: 8px; }
            h2 { font-size: 1.1em; margin-top: 15px; margin-bottom: 10px; }
            .update-info { font-size: 0.8em; }
            th, td { padding: 6px 8px; font-size: 0.8em; }
            #individual-controls { gap: 4px !important; margin-bottom: 8px !important; }
            input, select { padding: 6px !important; font-size: 0.85em; }
            button { padding: 6px 8px !important; font-size: 0.8em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ± JPA 028ãƒ‡ã‚£ãƒ“ã‚¸ãƒ§ãƒ³ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>
        <div class="update-info">
            <span id="checked-date">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</span>
            <span id="source-link"></span>
        </div>
        <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>é †ä½</th>
                    <th>ãƒãƒ¼ãƒ å (Team No.)</th>
                    <th class="points">ãƒã‚¤ãƒ³ãƒˆåˆè¨ˆ</th>
                </tr>
            </thead>
            <tbody id="ranking-body">
                <tr><td colspan="3" style="text-align: center;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</td></tr>
            </tbody>
        </table>
        </div>
        <h2 style="margin-top:30px;">å€‹äººæˆç¸¾</h2>

        <div id="individual-controls" style="margin-bottom:10px; display:flex; gap:8px; align-items:center;">
            <input id="search-name" type="search" placeholder="åå‰ã§æ¤œç´¢" style="flex:1; padding:8px; border-radius:6px; border:1px solid #ccc;">
            <select id="filter-team" style="padding:8px; border-radius:6px; border:1px solid #ccc;">
                <option value="">å…¨ãƒãƒ¼ãƒ </option>
            </select>
            <select id="filter-sl" style="padding:8px; border-radius:6px; border:1px solid #ccc;">
                <option value="">å…¨SL</option>
            </select>
            <button id="clear-filters" style="padding:8px 12px; border-radius:6px; background:#eee; border:1px solid #ccc; cursor:pointer;">ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="table-wrapper">
        <table id="individuals-table">
            <thead>
                <tr>
                    <th>ãƒãƒ¼ãƒ å</th>
                    <th>åå‰</th>
                    <th>SL</th>
                    <th>å‹åˆ©æ•° (TMW/TMP)</th>
                    <th class="points">å¹³å‡ç²å¾—ãƒã‚¤ãƒ³ãƒˆ</th>
                    <th class="points">ãƒã‚¤ãƒ³ãƒˆç‡</th>
                    <th>é †ä½</th>
                </tr>
            </thead>
            <tbody id="individuals-body">
                <tr><td colspan="7" style="text-align:center;">å€‹äººæˆç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</td></tr>
            </tbody>
        </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rankingBody = document.getElementById('ranking-body');
            const updateDateSpan = document.getElementById('update-date');
            const sourceLinkSpan = document.getElementById('source-link');
            
            // Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
            fetch('ranking_data.json?v=' + new Date().getTime()) // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ranking_data.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                    return response.json();
                })
                .then(data => {
                    rankingBody.innerHTML = ''; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
                    
                    // 1. ãƒã‚§ãƒƒã‚¯æ—¥æ™‚ã‚’è¡¨ç¤º
                    const checked = data.last_checked || null;
                    if (checked) {
                        document.getElementById('checked-date').textContent = `æœ€çµ‚ãƒã‚§ãƒƒã‚¯æ—¥æ™‚: ${checked} `;
                    } else {
                        document.getElementById('checked-date').textContent = 'æœ€çµ‚ãƒã‚§ãƒƒã‚¯æ—¥æ™‚: ä¸æ˜';
                    }
                    document.getElementById('source-link').innerHTML = data.source_pdf ? `(<a href="${data.source_pdf}" target="_blank">PDFã‚½ãƒ¼ã‚¹</a>)` : '';

                    // 2. ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ã‚’ç”Ÿæˆ
                    data.ranking.forEach((team, index) => {
                        const rank = index + 1;
                        const row = rankingBody.insertRow();
                        
                        let rankClass = '';
                        if (rank === 1) rankClass = 'gold';
                        else if (rank === 2) rankClass = 'silver';
                        else if (rank === 3) rankClass = 'bronze';

                        row.innerHTML = `
                            <td class="rank ${rankClass}">${rank}</td>
                            <td>${team.team_name} (No.${team.team_id})</td>
                            <td class="points">${team.points}</td>
                        `;
                    });

                    // 3. å€‹äººæˆç¸¾è¡¨ã‚’ç”Ÿæˆï¼ˆæ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿å¯¾å¿œï¼‰
                    const indBody = document.getElementById('individuals-body');
                    indBody.innerHTML = '';
                    const originalIndividuals = Array.isArray(data.individuals) ? data.individuals.slice() : [];

                    // å…¨ä½“é †ä½ãƒãƒƒãƒ—ã‚’ä½œæˆï¼ˆavg_points é™é †ï¼‰ã€‚ãƒ•ã‚£ãƒ«ã‚¿å¾Œã‚‚ã“ã®é †ä½ã‚’è¡¨ç¤ºã™ã‚‹ã€‚
                    const sortedForRank = originalIndividuals.slice().sort((a, b) => parseFloat(b.avg_points) - parseFloat(a.avg_points));
                    const ranksMap = {};
                    // åŒç‚¹ã¯åŒé †ä½ã«ã™ã‚‹ï¼ˆæ¨™æº–ç«¶æŠ€é †ä½: 1,2,2,4 ã®ã‚ˆã†ã«ã‚¹ã‚­ãƒƒãƒ—ã‚ã‚Šï¼‰
                    let lastAvg = null;
                    let lastRank = 0;
                    sortedForRank.forEach((p, i) => {
                        const key = `${p.team_name}||${p.player_name}`;
                        const avg = parseFloat(p.avg_points) || 0;
                        let rank;
                        if (i === 0) {
                            rank = 1;
                            lastAvg = avg;
                            lastRank = 1;
                        } else {
                            if (Math.abs(avg - lastAvg) < 1e-9) {
                                rank = lastRank;
                            } else {
                                rank = i + 1;
                                lastAvg = avg;
                                lastRank = rank;
                            }
                        }
                        ranksMap[key] = rank;
                    });

                    // ãƒ“ãƒ«ãƒ‰: ãƒãƒ¼ãƒ ã¨SLã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                    const teamSelect = document.getElementById('filter-team');
                    const slSelect = document.getElementById('filter-sl');
                    const names = new Set();
                    const teams = new Set();
                    const sls = new Set();
                    originalIndividuals.forEach(p => { teams.add(p.team_name); sls.add(p.sl); names.add(p.player_name); });
                    // populate team options
                    const sortedTeams = Array.from(teams).sort((a,b)=>a.localeCompare(b,'ja'));
                    sortedTeams.forEach(t => {
                        const o = document.createElement('option'); o.value = t; o.textContent = t; teamSelect.appendChild(o);
                    });
                    const sortedSls = Array.from(sls).sort((a,b)=>a-b);
                    sortedSls.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; slSelect.appendChild(o); });

                    // render function
                    function renderIndividuals(list) {
                        indBody.innerHTML = '';
                        if (!list || list.length === 0) {
                            indBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">å€‹äººæˆç¸¾ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚</td></tr>';
                            return;
                        }
                        list.forEach((person) => {
                            const row = indBody.insertRow();
                            const avg = (typeof person.avg_points === 'number') ? person.avg_points.toFixed(2) : parseFloat(person.avg_points || 0).toFixed(2);
                            const key = `${person.team_name}||${person.player_name}`;
                            const rank = ranksMap[key] || '';
                            row.innerHTML = `
                                <td>${person.team_name}</td>
                                <td>${person.player_name}</td>
                                <td>${person.sl}</td>
                                <td>${person.wins}</td>
                                <td class="points">${avg}</td>
                                <td class="points">${person.points_rate}</td>
                                <td class="rank">${rank}</td>
                            `;
                        });
                    }

                    // filtering
                    const searchInput = document.getElementById('search-name');
                    const clearBtn = document.getElementById('clear-filters');
                    function applyFilters() {
                        const q = searchInput.value.trim().toLowerCase();
                        const teamVal = teamSelect.value;
                        const slVal = slSelect.value;
                        let filtered = originalIndividuals.filter(p => true);
                        if (q) filtered = filtered.filter(p => (p.player_name || '').toLowerCase().includes(q));
                        if (teamVal) filtered = filtered.filter(p => p.team_name === teamVal);
                        if (slVal) filtered = filtered.filter(p => String(p.sl) === String(slVal));
                        // sort by average points (é™é †)
                        filtered.sort((a, b) => parseFloat(b.avg_points) - parseFloat(a.avg_points));
                        renderIndividuals(filtered);
                    }

                    searchInput.addEventListener('input', applyFilters);
                    teamSelect.addEventListener('change', applyFilters);
                    slSelect.addEventListener('change', applyFilters);
                    clearBtn.addEventListener('click', ()=>{ searchInput.value=''; teamSelect.value=''; slSelect.value=''; applyFilters(); });

                    // initial render: å¹³å‡ç²å¾—ãƒã‚¤ãƒ³ãƒˆé †ï¼ˆé™é †ï¼‰ã§è¡¨ç¤º
                    renderIndividuals(originalIndividuals.sort((a, b) => b.avg_points - a.avg_points));
                })
                .catch(error => {
                    console.error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    rankingBody.innerHTML = '<tr><td colspan="3" style="color: red; text-align: center;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</td></tr>';
                    updateDateSpan.textContent = 'æœ€çµ‚æ›´æ–°æ—¥æ™‚: ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼';
                });
        });
    </script>
</body>
</html>
